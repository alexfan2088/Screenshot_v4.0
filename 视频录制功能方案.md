# 视频录制功能技术方案

## 一、功能概述

在现有音频录制功能基础上，增加屏幕视频录制功能，支持可配置的视频质量参数，以优化文件大小。

## 二、技术选型

### 2.1 视频捕获技术
- **Windows Graphics Capture API** (已安装依赖)
  - 优点：Windows 10/11 原生支持，性能好，无需第三方库
  - 支持：全屏、窗口、区域捕获
  - 已安装：`Microsoft.Windows.CsWinRT` 和 `Microsoft.Windows.SDK.BuildTools`

### 2.2 视频编码库

**方案 A：Windows Media Foundation（强烈推荐）⭐⭐⭐**
- **优点**：
  - ✅ **Windows 10/11 原生内置，无需任何额外安装**
  - ✅ **用户零配置，开箱即用**
  - ✅ **性能优秀，硬件加速支持**
  - ✅ **支持 H.264 编码**
  - ✅ **文件体积小（应用无需打包额外文件）**
- **缺点**：
  - ❌ 不支持 H.265/HEVC（需要额外编码器）
  - ❌ 配置选项相对有限（但足够使用）
- **使用**：`Windows.Media.MediaProperties` API
- **NuGet 包**：无需额外包，使用 Windows SDK（已安装）

**方案 B：FFmpeg（打包到应用中）**
- **优点**：
  - ✅ 功能强大，支持多种编码格式
  - ✅ 压缩效果好，支持 H.265
- **缺点**：
  - ❌ 需要打包 FFmpeg 二进制文件（约 50-100MB，增加应用体积）
  - ❌ 需要处理 FFmpeg 许可证（LGPL/GPL）
  - ❌ 首次运行可能需要解压文件
- **NuGet 包**：`FFmpeg.AutoGen` 或直接调用 FFmpeg.exe

**方案 C：SharpAvi（纯 .NET）**
- **优点**：
  - ✅ 纯 .NET 实现，无需外部依赖
  - ✅ 应用体积小
- **缺点**：
  - ❌ 压缩效果一般（文件较大）
  - ❌ 功能有限
  - ❌ 性能相对较差

**推荐：方案 A（Windows Media Foundation）**，因为：
- ✅ **用户体验最佳**：无需任何额外安装或配置
- ✅ **应用体积小**：不增加额外文件
- ✅ **性能好**：Windows 原生 API，支持硬件加速
- ✅ **功能足够**：支持 H.264，满足大部分需求

### 2.3 音频和视频合成

**重要：完全不需要 FFmpeg！**

- **音频捕获**：继续使用现有的 `NAudio` 进行音频捕获（录制为 WAV）
- **视频捕获**：使用 Windows Graphics Capture API 捕获屏幕帧
- **合成编码**：使用 **Windows Media Foundation 的 Sink Writer** 将音频和视频流同时写入同一个 MP4 文件

**工作原理**：
1. 使用 `IMFSinkWriter` 创建 MP4 写入器
2. 添加视频流（H.264 编码）
3. 添加音频流（AAC 编码）
4. 同时写入视频帧和音频样本到同一个 MP4 文件
5. 完成时，WMF 自动处理同步和容器格式

**优势**：
- ✅ 无需 FFmpeg
- ✅ 无需临时文件合并
- ✅ 实时同步音频和视频
- ✅ 原生支持 MP4 容器格式

## 三、视频文件大小优化策略

### 3.1 分辨率压缩（已提出）
- **10%-100%**：按百分比缩放长宽
- 例如：1920x1080 → 10% = 192x108, 50% = 960x540, 100% = 1920x1080
- **影响**：线性影响文件大小（分辨率减半，文件约减至 1/4）

### 3.2 帧率（FPS）压缩
- **选项**：15fps, 24fps, 30fps, 60fps
- **默认**：30fps（平衡质量和大小）
- **影响**：帧率减半，文件约减半
- **建议**：
  - 15fps：适合静态内容（PPT、文档）
  - 24fps：电影标准，适合一般录制
  - 30fps：流畅录制（推荐）
  - 60fps：高流畅度（文件较大）

### 3.3 视频码率（Bitrate）
- **选项**：低（1Mbps）、中（3Mbps）、高（5Mbps）、自动
- **影响**：码率减半，文件约减半
- **建议**：
  - 1Mbps：适合低分辨率（720p以下）
  - 3Mbps：适合中等分辨率（1080p）
  - 5Mbps：适合高分辨率（1080p+）
  - 自动：根据分辨率动态调整

### 3.4 编码格式
- **H.264（AVC）**：兼容性好，压缩比中等（Media Foundation 原生支持，推荐）
- **H.265（HEVC）**：压缩比高（文件小30-50%），但需要额外编码器（Media Foundation 需要安装 HEVC 扩展）
- **VP9**：开源，压缩比高，但 Media Foundation 不支持

**注意**：使用 Media Foundation 时，默认支持 H.264。H.265 需要用户安装 "HEVC 视频扩展"（Windows Store 免费），但这不是必需的。

### 3.5 音频优化
- **采样率**：44.1kHz（标准）、22.05kHz（节省空间）
- **比特率**：64kbps、128kbps、192kbps
- **格式**：AAC（推荐，兼容性好，压缩比高）

### 3.6 其他优化
- **关键帧间隔（GOP）**：影响压缩效率
- **编码预设**：ultrafast, fast, medium, slow（影响编码速度和质量）

## 四、配置菜单设计

### 4.1 菜单结构
```
设置菜单
├── 视频质量
│   ├── 分辨率比例：10% - 100%（滑块，步长10%）
│   ├── 帧率：15/24/30/60 fps（下拉框）
│   ├── 视频码率：低/中/高/自动（下拉框）
│   └── 编码格式：H.264 / H.265（单选）
├── 音频质量
│   ├── 采样率：44.1kHz / 22.05kHz（单选）
│   └── 音频比特率：64/128/192 kbps（下拉框）
└── 高级设置
    ├── 编码预设：ultrafast/fast/medium/slow
    └── 关键帧间隔：自动/自定义
```

### 4.2 预设方案（快速选择）
- **最小文件**：10%分辨率，15fps，1Mbps，H.265，22.05kHz，64kbps
- **平衡模式**：50%分辨率，30fps，3Mbps，H.264，44.1kHz，128kbps（推荐）
- **高质量**：100%分辨率，60fps，5Mbps，H.264，44.1kHz，192kbps
- **自定义**：手动配置所有参数

### 4.3 配置保存
- 使用 JSON 文件保存配置（`config.json`）
- 保存在工作目录或用户配置目录
- 启动时自动加载

## 五、界面设计

### 5.1 主界面更新
```
┌─────────────────────────────────────┐
│  智能截屏 v3.0                      │
├─────────────────────────────────────┤
│  [开始录制视频] [停止录制]          │
│  [开始录音]   [停止录音]            │
├─────────────────────────────────────┤
│  当前配置：                          │
│  视频：50%分辨率，30fps，H.264      │
│  音频：44.1kHz，128kbps              │
│  预计文件大小：~50MB/分钟            │
├─────────────────────────────────────┤
│  日志信息...                         │
└─────────────────────────────────────┘
```

### 5.2 设置窗口
- 独立的设置窗口（Window）
- 使用 TabControl 分组（视频/音频/高级）
- 实时显示预计文件大小

## 六、实现架构

### 6.1 新增类
1. **VideoRecorder.cs**
   - 负责屏幕捕获
   - 使用 Windows Graphics Capture API
   - 将帧数据传递给编码器

2. **VideoEncoder.cs**
   - 负责视频编码和音频视频合成
   - 使用 Windows Media Foundation 的 `IMFSinkWriter` API
   - 同时处理视频流（H.264）和音频流（AAC）
   - 实时将两个流写入同一个 MP4 文件
   - 处理分辨率、帧率、码率等参数
   - **无需 FFmpeg，完全使用 WMF 原生功能**

3. **RecordingConfig.cs**
   - 配置数据模型
   - 序列化/反序列化

4. **SettingsWindow.xaml/cs**
   - 设置界面
   - 配置管理

### 6.2 文件结构
```
Screenshot_v3.0/
├── AudioRecorder.cs          (已有)
├── VideoRecorder.cs          (新增)
├── VideoEncoder.cs           (新增)
├── RecordingConfig.cs        (新增)
├── MainWindow.xaml/cs        (修改)
├── SettingsWindow.xaml/cs    (新增)
└── config.json               (新增，配置文件)
```

## 七、依赖包

### 7.1 需要添加的 NuGet 包
```xml
<!-- JSON 配置 -->
<PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
```

**注意**：使用 Media Foundation 不需要额外的视频编码库，Windows SDK 已包含所需 API。

### 7.2 外部依赖
- ✅ **无需任何外部依赖**
- ✅ Windows 10/11 内置 Media Foundation
- ✅ 用户无需安装任何额外软件

## 八、文件大小估算

### 8.1 不同配置的文件大小（1分钟录制）

| 分辨率 | 帧率 | 码率 | 编码 | 预计大小 |
|--------|------|------|------|----------|
| 100% (1920x1080) | 60fps | 5Mbps | H.264 | ~37MB |
| 100% (1920x1080) | 30fps | 3Mbps | H.264 | ~22MB |
| 50% (960x540) | 30fps | 3Mbps | H.264 | ~22MB |
| 50% (960x540) | 30fps | 1Mbps | H.265 | ~7MB |
| 25% (480x270) | 15fps | 1Mbps | H.265 | ~7MB |
| 10% (192x108) | 15fps | 0.5Mbps | H.265 | ~3MB |

*注：实际大小取决于内容复杂度*

## 九、实施步骤

### 阶段 1：基础功能
1. ~~添加 FFmpeg 依赖~~（不需要）
2. 实现 VideoRecorder（屏幕捕获，使用 Windows Graphics Capture API）
3. 实现 VideoEncoder（使用 WMF Sink Writer 进行编码和合成）
4. 集成到主界面

### 阶段 2：配置功能
1. 创建配置数据模型
2. 实现设置窗口
3. 实现配置保存/加载
4. 应用配置到录制

### 阶段 3：优化
1. 文件大小估算
2. 性能优化
3. 错误处理
4. 用户体验优化

## 十、注意事项

1. **Media Foundation 支持**：Windows 10/11 内置，无需担心兼容性
2. **性能影响**：高分辨率录制会占用较多 CPU/GPU，Media Foundation 支持硬件加速
3. **磁盘空间**：录制前检查可用空间
4. **权限**：屏幕捕获需要用户授权（Windows 10/11 会自动提示）
5. **H.265 支持**：可选，需要用户安装 "HEVC 视频扩展"（Windows Store 免费），但不影响基本功能

## 十一、方案对比总结

| 方案 | 用户安装 | 应用体积 | 压缩效果 | 推荐度 |
|------|---------|---------|---------|--------|
| **Media Foundation** | ❌ 无需 | ✅ 小 | ⭐⭐⭐ 好 | ⭐⭐⭐ **强烈推荐** |
| FFmpeg（打包） | ❌ 无需 | ❌ 大（+50-100MB） | ⭐⭐⭐⭐ 很好 | ⭐⭐ |
| FFmpeg（用户安装） | ✅ 需要 | ✅ 小 | ⭐⭐⭐⭐ 很好 | ⭐ 不推荐 |
| SharpAvi | ❌ 无需 | ✅ 小 | ⭐⭐ 一般 | ⭐ |

**最终推荐：Windows Media Foundation**
- 用户体验最佳（零配置）
- 应用体积最小
- 功能完全满足需求

---

## 待确认问题

1. **Media Foundation 方案是否接受？**（推荐，无需任何额外安装）
2. **预设方案是否满足需求？**
3. **是否需要区域录制功能？**（选择屏幕区域）
4. **是否需要窗口选择功能？**（选择特定窗口）
5. **文件格式选择？**（MP4 推荐，Media Foundation 原生支持）

---

## ✅ 最终推荐方案

**使用 Windows Media Foundation**：
- ✅ 用户无需安装任何软件
- ✅ 应用体积小
- ✅ 性能好，支持硬件加速
- ✅ 功能完全满足需求
- ✅ 开发相对简单

