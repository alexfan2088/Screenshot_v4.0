# 视频录制功能代码实现说明

## 一、文件结构

### 新增文件

```
Screenshot_v3.0/
├── RecordingConfig.cs          (新增) 配置数据模型
├── VideoRecorder.cs            (新增) 屏幕捕获（Windows Graphics Capture API）
├── VideoEncoder.cs             (新增) 视频编码和音频视频合成（WMF Sink Writer）
├── SettingsWindow.xaml         (新增) 设置窗口界面
├── SettingsWindow.xaml.cs      (新增) 设置窗口逻辑
└── config.json                 (新增) 配置文件（自动生成）
```

### 修改文件

```
Screenshot_v3.0/
├── MainWindow.xaml             (修改) 添加视频录制按钮和设置菜单
├── MainWindow.xaml.cs          (修改) 添加视频录制逻辑
└── Screenshot_v3.0.csproj      (修改) 添加 Newtonsoft.Json 依赖
```

## 二、代码架构原理

### 2.1 整体架构

```
┌─────────────────────────────────────────────────┐
│              MainWindow (主窗口)                 │
│  ┌──────────────┐  ┌──────────────┐            │
│  │ 音频录制按钮 │  │ 视频录制按钮 │            │
│  └──────┬───────┘  └──────┬───────┘            │
│         │                  │                     │
│         ▼                  ▼                     │
│  ┌──────────────┐  ┌──────────────┐            │
│  │AudioRecorder │  │VideoRecorder  │            │
│  │  (NAudio)    │  │(Graphics      │            │
│  │              │  │ Capture API)  │            │
│  └──────────────┘  └──────┬───────┘            │
│                           │                     │
│                           ▼                     │
│                    ┌──────────────┐            │
│                    │VideoEncoder  │            │
│                    │(WMF Sink     │            │
│                    │ Writer)      │            │
│                    └──────┬───────┘            │
│                           │                     │
│                           ▼                     │
│                    video.mp4 (输出)            │
└─────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────┐
│          SettingsWindow (设置窗口)               │
│  ┌──────────────────────────────────────────┐   │
│  │ 配置参数：                               │   │
│  │ - 分辨率比例 (10%-100%)                 │   │
│  │ - 帧率 (15/24/30/60 fps)                │   │
│  │ - 视频码率 (低/中/高/自动)               │   │
│  │ - 音频采样率 (22.05/44.1 kHz)            │   │
│  │ - 音频比特率 (64/128/192 kbps)           │   │
│  └──────────────────────────────────────────┘   │
│                    │                             │
│                    ▼                             │
│              RecordingConfig                      │
│              (配置模型)                          │
│                    │                             │
│                    ▼                             │
│              config.json (保存)                  │
└─────────────────────────────────────────────────┘
```

### 2.2 核心类说明

#### 1. RecordingConfig.cs
**作用**：配置数据模型
- 存储所有录制参数（分辨率、帧率、码率等）
- 序列化/反序列化到 JSON 文件
- 提供默认配置

#### 2. VideoRecorder.cs
**作用**：屏幕捕获
- 使用 Windows Graphics Capture API 捕获屏幕
- 支持全屏捕获
- 将捕获的帧传递给 VideoEncoder

**工作原理**：
```
1. 创建 GraphicsCaptureSession
2. 设置 FrameArrived 事件
3. 每帧到达时，转换为位图
4. 将位图传递给 VideoEncoder
```

#### 3. VideoEncoder.cs
**作用**：视频编码和音频视频合成
- 使用 WMF 的 IMFSinkWriter 进行编码
- 同时处理视频流和音频流
- 实时合成到 MP4 文件

**工作原理**：
```
1. 初始化 WMF (MFStartup)
2. 创建 Sink Writer (MFCreateSinkWriterFromURL)
3. 添加视频流 (AddStream) - H.264
4. 添加音频流 (AddStream) - AAC
5. 开始写入 (BeginWriting)
6. 接收视频帧 → WriteSample (视频流)
7. 接收音频样本 → WriteSample (音频流)
8. 完成写入 (Finalize)
9. 关闭 WMF (MFShutdown)
```

#### 4. SettingsWindow.xaml/cs
**作用**：配置界面
- 提供滑块、下拉框等控件
- 实时显示预计文件大小
- 保存/加载配置

### 2.3 数据流

#### 视频录制流程

```
用户点击"开始录制视频"
    ↓
MainWindow 创建 VideoRecorder 和 VideoEncoder
    ↓
VideoRecorder 开始捕获屏幕帧
    ├─→ 每帧到达 → 转换为位图 → VideoEncoder.WriteVideoFrame()
    │
VideoEncoder 初始化 WMF Sink Writer
    ├─→ 添加视频流 (H.264)
    ├─→ 添加音频流 (AAC)
    └─→ 开始写入
    ↓
AudioRecorder 开始录制音频（如果启用）
    ├─→ 音频样本 → VideoEncoder.WriteAudioSample()
    │
VideoEncoder 同时写入视频帧和音频样本
    ├─→ WriteSample(视频流, 视频帧)
    └─→ WriteSample(音频流, 音频样本)
    ↓
用户点击"停止录制"
    ↓
VideoRecorder 停止捕获
AudioRecorder 停止录制
    ↓
VideoEncoder.Finalize()
    ↓
输出 video.mp4 (包含音视频)
```

### 2.4 关键技术点

#### Windows Graphics Capture API
```csharp
// 1. 获取显示器
var display = DisplayMonitor.GetFromMonitorHandle(monitorHandle);

// 2. 创建捕获会话
var captureItem = GraphicsCaptureItem.CreateFromMonitor(display);
var session = captureItem.CreateCaptureSession();

// 3. 设置帧到达事件
captureItem.Closed += OnCaptureItemClosed;
framePool.FrameArrived += OnFrameArrived;

// 4. 开始捕获
session.StartCapture();
```

#### Windows Media Foundation Sink Writer
```csharp
// 1. 初始化 WMF
MFStartup();

// 2. 创建 Sink Writer
MFCreateSinkWriterFromURL(outputPath, null, null, out sinkWriter);

// 3. 配置视频流
var videoMediaType = CreateVideoMediaType(width, height, fps, bitrate);
var videoStreamIndex = sinkWriter.AddStream(videoMediaType);

// 4. 配置音频流
var audioMediaType = CreateAudioMediaType(sampleRate, channels, bitrate);
var audioStreamIndex = sinkWriter.AddStream(audioMediaType);

// 5. 开始写入
sinkWriter.BeginWriting();

// 6. 写入视频帧
sinkWriter.WriteSample(videoStreamIndex, videoSample);

// 7. 写入音频样本
sinkWriter.WriteSample(audioStreamIndex, audioSample);

// 8. 完成
sinkWriter.Finalize();
MFShutdown();
```

## 三、配置参数说明

### 3.1 视频参数

| 参数 | 范围/选项 | 说明 |
|------|----------|------|
| 分辨率比例 | 10%-100% | 按百分比缩放长宽 |
| 帧率 | 15/24/30/60 fps | 每秒帧数 |
| 视频码率 | 低(1Mbps)/中(3Mbps)/高(5Mbps)/自动 | 视频比特率 |

### 3.2 音频参数

| 参数 | 范围/选项 | 说明 |
|------|----------|------|
| 采样率 | 22.05kHz / 44.1kHz | 音频采样频率 |
| 音频比特率 | 64/128/192 kbps | 音频比特率 |

### 3.3 默认配置

```json
{
  "VideoResolutionScale": 50,
  "VideoFrameRate": 30,
  "VideoBitrate": "Auto",
  "AudioSampleRate": 44100,
  "AudioBitrate": 128
}
```

## 四、文件大小估算

根据配置参数，实时计算预计文件大小：

```
文件大小(MB/分钟) = (视频码率(Mbps) + 音频码率(Mbps)) × 60 / 8
```

例如：
- 视频码率：3Mbps，音频码率：128kbps (0.128Mbps)
- 预计大小 = (3 + 0.128) × 60 / 8 ≈ 23.5 MB/分钟

## 五、错误处理

1. **屏幕捕获失败**：提示用户检查权限
2. **WMF 初始化失败**：提示系统不支持
3. **编码失败**：记录错误日志，提示用户
4. **磁盘空间不足**：录制前检查可用空间

## 六、性能优化

1. **异步处理**：视频帧和音频样本的写入使用异步
2. **缓冲管理**：合理设置缓冲区大小
3. **硬件加速**：WMF 自动使用硬件加速（如果可用）
4. **内存管理**：及时释放位图和样本资源

---

## 下一步

准备好后，我将按照这个架构实现所有代码文件。









